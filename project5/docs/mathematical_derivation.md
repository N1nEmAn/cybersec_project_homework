# SM2椭圆曲线数字签名算法：数学原理与推导

## 1. 椭圆曲线基础理论

### 1.1 椭圆曲线定义

椭圆曲线 $E$ 在有限域 $\mathbb{F}_p$ 上的Weierstrass标准形式为：

$$E: y^2 = x^3 + ax + b \pmod{p}$$

其中 $a, b \in \mathbb{F}_p$ 且判别式 $\Delta = -16(4a^3 + 27b^2) \neq 0$。

### 1.2 SM2推荐椭圆曲线参数

根据GM/T 0003.2-2012标准，SM2使用的椭圆曲线参数为：

- **素数** $p = 2^{256} - 2^{224} - 2^{96} + 2^{64} - 1$
- **参数** $a = p - 3$  
- **参数** $b = $ `28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93`
- **基点** $G = (x_G, y_G)$
- **阶** $n = $ `FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B61C6823781B4B10E0B3BCF0`

## 2. 椭圆曲线点运算

### 2.1 点加法公式（仿射坐标系）

对于椭圆曲线上的两点 $P_1 = (x_1, y_1)$ 和 $P_2 = (x_2, y_2)$，其和 $P_3 = P_1 + P_2 = (x_3, y_3)$ 的计算公式为：

**情况1：** $P_1 \neq P_2$ 且 $x_1 \neq x_2$

$$\lambda = \frac{y_2 - y_1}{x_2 - x_1} \pmod{p}$$

$$x_3 = \lambda^2 - x_1 - x_2 \pmod{p}$$

$$y_3 = \lambda(x_1 - x_3) - y_1 \pmod{p}$$

**情况2：** $P_1 = P_2$（点倍乘）

$$\lambda = \frac{3x_1^2 + a}{2y_1} \pmod{p}$$

$$x_3 = \lambda^2 - 2x_1 \pmod{p}$$

$$y_3 = \lambda(x_1 - x_3) - y_1 \pmod{p}$$

### 2.2 雅可比坐标系优化

为减少模逆运算，采用雅可比坐标系 $(X:Y:Z)$，其中仿射坐标为 $(X/Z^2, Y/Z^3)$。

**点倍乘公式（雅可比坐标系）：**

输入：$P = (X_1, Y_1, Z_1)$  
输出：$2P = (X_3, Y_3, Z_3)$

$$A = Y_1^2$$
$$B = 4X_1A$$  
$$C = 8A^2$$
$$D = 3X_1^2 + aZ_1^4$$
$$X_3 = D^2 - 2B$$
$$Y_3 = D(B - X_3) - C$$
$$Z_3 = 2Y_1Z_1$$

**点加法公式（雅可比坐标系）：**

输入：$P_1 = (X_1, Y_1, Z_1)$, $P_2 = (X_2, Y_2, Z_2)$  
输出：$P_1 + P_2 = (X_3, Y_3, Z_3)$

$$Z_1Z_1 = Z_1^2, \quad Z_2Z_2 = Z_2^2$$
$$U_1 = X_1 \cdot Z_2Z_2, \quad U_2 = X_2 \cdot Z_1Z_1$$
$$S_1 = Y_1 \cdot Z_2 \cdot Z_2Z_2, \quad S_2 = Y_2 \cdot Z_1 \cdot Z_1Z_1$$
$$H = U_2 - U_1, \quad r = 2(S_2 - S_1)$$
$$I = (2H)^2, \quad J = H \cdot I, \quad V = U_1 \cdot I$$
$$X_3 = r^2 - J - 2V$$
$$Y_3 = r(V - X_3) - S_1 \cdot J$$
$$Z_3 = Z_1 \cdot Z_2 \cdot H$$

## 3. 标量乘法优化算法

### 3.1 二进制展开法

对于标量 $k = \sum_{i=0}^{t-1} k_i 2^i$，计算 $kP$ 的基本算法：

```
算法：标量乘法
输入：标量 k，椭圆曲线点 P
输出：kP

1. Q ← O（无穷远点）
2. for i = t-1 down to 0 do
3.    Q ← 2Q
4.    if k_i = 1 then Q ← Q + P
5. return Q
```

**时间复杂度：** $O(\log k)$ 次点倍乘 + $O(\log k / 2)$ 次点加法

### 3.2 Montgomery阶梯算法

为防止侧信道攻击，采用Montgomery阶梯算法：

```
算法：Montgomery阶梯
输入：标量 k，椭圆曲线点 P
输出：kP

1. R0 ← O, R1 ← P
2. for i = t-1 down to 0 do
3.    if k_i = 0 then
4.       R1 ← R0 + R1
5.       R0 ← 2R0
6.    else
7.       R0 ← R0 + R1  
8.       R1 ← 2R1
9. return R0
```

### 3.3 窗口方法（w-NAF）

使用窗口大小为 $w$ 的Non-Adjacent Form (NAF)：

**预计算表：** $\{P, 3P, 5P, \ldots, (2^w-1)P\}$

**时间复杂度：** $\frac{t}{w+1}$ 次点加法 + $t$ 次点倍乘

**空间复杂度：** $2^{w-2}$ 个预计算点

## 4. SM2数字签名算法

### 4.1 密钥生成

1. 随机选择私钥 $d \in [1, n-1]$
2. 计算公钥 $P = dG$
3. 输出密钥对 $(d, P)$

### 4.2 签名生成

**输入：** 消息 $M$，私钥 $d$  
**输出：** 签名 $(r, s)$

1. 计算消息摘要 $e = H(M)$
2. 随机选择 $k \in [1, n-1]$  
3. 计算 $(x_1, y_1) = kG$
4. 计算 $r = (e + x_1) \bmod n$
5. 若 $r = 0$ 或 $r + k = n$，返回步骤2
6. 计算 $s = (1 + d)^{-1}(k - rd) \bmod n$
7. 若 $s = 0$，返回步骤2
8. 输出签名 $(r, s)$

### 4.3 签名验证

**输入：** 消息 $M$，签名 $(r, s)$，公钥 $P$  
**输出：** 验证结果（通过/失败）

1. 验证 $r, s \in [1, n-1]$
2. 计算消息摘要 $e = H(M)$
3. 计算 $t = (r + s) \bmod n$
4. 若 $t = 0$，则验证失败
5. 计算 $(x_1, y_1) = sG + tP$
6. 计算 $R = (e + x_1) \bmod n$
7. 若 $R = r$，则验证通过；否则失败

## 5. 安全性分析

### 5.1 椭圆曲线离散对数问题（ECDLP）

SM2算法的安全性基于ECDLP的困难性：

**问题定义：** 给定椭圆曲线上的点 $P$ 和 $Q$，找到整数 $k$ 使得 $Q = kP$。

**最佳已知攻击：** Pollard's rho算法，时间复杂度 $O(\sqrt{n})$

**256位椭圆曲线安全强度：** 约128位对称密钥等价

### 5.2 签名方案安全性

**存在性不可伪造性（EUF-CMA）：** 在随机预言机模型下，SM2签名方案在ECDLP假设下是安全的。

**关键安全要求：**
1. 随机数 $k$ 必须每次签名时重新生成
2. 随机数 $k$ 不能泄露或被预测  
3. 私钥 $d$ 必须安全存储

## 6. 性能优化技术

### 6.1 预计算优化

**固定基点乘法：** 预计算 $\{G, 2G, 4G, \ldots, 2^{255}G\}$

**空间-时间权衡：** 存储 $t/w$ 个预计算值，减少 $\frac{w-1}{w+1}$ 的计算量

### 6.2 批量验证

对于 $m$ 个签名 $(r_i, s_i)$，可以使用批量验证：

$$\sum_{i=1}^m a_i(s_i G + t_i P_i) = \sum_{i=1}^m a_i R_i$$

其中 $a_i$ 是随机数，$t_i = r_i + s_i$，$R_i = (e_i + x_{1,i}, *)$

**验证复杂度：** 从 $O(m)$ 降低到 $O(m/\log m)$

### 6.3 并行化策略

**多标量乘法：** 同时计算 $k_1P_1 + k_2P_2 + \cdots + k_mP_m$

**Straus算法：** 时间复杂度 $O(\log \max k_i + m)$

**Pippenger算法：** 对于大 $m$，复杂度 $O(\frac{\log \max k_i}{\log \log \max k_i})$

## 7. 实现考虑

### 7.1 侧信道攻击防护

**时间攻击防护：** 使用Montgomery阶梯或固定时间算法

**功耗攻击防护：** 点混淆和随机化技术

**故障攻击防护：** 冗余计算和完整性检查

### 7.2 模运算优化

**Barrett约简：** 对于固定模数的快速模约简

**Montgomery约简：** 特别适用于连续模乘运算

**模逆算法：** 扩展欧几里得算法或Fermat小定理 $a^{p-2} \bmod p$

## 8. 复杂度分析总结

| 操作 | 基础实现 | 雅可比坐标 | 预计算表 | 窗口方法 |
|------|----------|------------|----------|----------|
| 点加法 | $I + 2M$ | $12M$ | $12M$ | $12M$ |
| 点倍乘 | $I + 2M$ | $8M$ | $8M$ | $8M$ |
| 标量乘法 | $1.5t(I + 2M)$ | $1.5t \cdot 8M$ | $t \cdot 8M$ | $\frac{t}{w+1} \cdot 12M + t \cdot 8M$ |

其中：$I$ = 模逆运算，$M$ = 模乘运算，$t$ = 标量位长度

**注：** 模逆运算 $I \approx 80M$，因此雅可比坐标系带来显著性能提升。
