# SM2椭圆曲线数字签名算法数学推导

## 1. 椭圆曲线基础数学

### 1.1 椭圆曲线定义

SM2使用素数域Fp上的椭圆曲线，其韦尔斯特拉斯标准形式为：

```
E: y² = x³ + ax + b (mod p)
```

其中：
- p是大于3的素数
- a, b ∈ Fp
- 判别式 Δ = 4a³ + 27b² ≠ 0 (mod p)

### 1.2 椭圆曲线群运算

#### 单位元
无穷远点 O 是椭圆曲线群的单位元。

#### 逆元
点P = (x, y)的逆元为 -P = (x, -y mod p)

#### 点加法
设P₁ = (x₁, y₁), P₂ = (x₂, y₂)为椭圆曲线上两点：

**情况1: P₁ ≠ P₂**
```
λ = (y₂ - y₁) · (x₂ - x₁)⁻¹ mod p
x₃ = λ² - x₁ - x₂ mod p
y₃ = λ(x₁ - x₃) - y₁ mod p
```

**情况2: P₁ = P₂ (点倍乘)**
```
λ = (3x₁² + a) · (2y₁)⁻¹ mod p
x₃ = λ² - 2x₁ mod p
y₃ = λ(x₁ - x₃) - y₁ mod p
```

### 1.3 标量乘法

椭圆曲线标量乘法定义为：
```
[k]P = P + P + ... + P (k次)
```

这是椭圆曲线密码学的核心运算，其安全性基于椭圆曲线离散对数问题(ECDLP)：

> 给定椭圆曲线上的点P和Q，找到整数k使得Q = [k]P

## 2. SM2算法数学推导

### 2.1 密钥生成

**输入**: 椭圆曲线E(Fp)和基点G
**输出**: 私钥d和公钥P

```
1. 随机选择 d ∈ [1, n-1]
2. 计算 P = [d]G
3. 输出 (d, P)
```

**正确性证明**: 
私钥d的随机性确保了密钥的不可预测性，而P = [d]G的计算基于ECDLP的困难性保证安全性。

### 2.2 数字签名

**输入**: 消息M，私钥d
**输出**: 签名(r, s)

```
1. e = H(ZA || M) 计算摘要 (ZA为用户身份摘要)
2. 随机选择 k ∈ [1, n-1]
3. 计算 (x₁, y₁) = [k]G
4. r = (e + x₁) mod n
5. s = (1 + d)⁻¹(k - rd) mod n
6. 如果 r = 0 或 s = 0，返回步骤2
7. 输出 (r, s)
```

**数学正确性**:
从步骤4和5可得：
```
r = (e + x₁) mod n
s(1 + d) = k - rd mod n
k = s(1 + d) + rd mod n
```

### 2.3 签名验证

**输入**: 消息M，签名(r, s)，公钥P
**输出**: 验证结果(True/False)

```
1. 检查 r, s ∈ [1, n-1]
2. e = H(ZA || M)
3. t = (r + s) mod n
4. 计算 (x₁, y₁) = [s]G + [t]P
5. R = (e + x₁) mod n
6. 验证 R = r
```

**数学证明**:
```
[s]G + [t]P = [s]G + [t][d]G = [s + td]G

其中：
t = (r + s) mod n
s + td = s + (r + s)d = s(1 + d) + rd mod n

由签名算法知：k = s(1 + d) + rd mod n

因此：[s]G + [t]P = [k]G = (x₁, y₁)
```

所以验证算法中的x₁与签名时的x₁相同，验证成功。

## 3. 优化技术数学分析

### 3.1 雅可比坐标系

仿射坐标到雅可比坐标的转换：
```
(x, y) → (X, Y, Z) 其中 x = X/Z², y = Y/Z³
```

#### 点加法公式（雅可比坐标）
设P₁ = (X₁, Y₁, Z₁), P₂ = (X₂, Y₂, Z₂)：

```
U₁ = X₁Z₂², U₂ = X₂Z₁²
S₁ = Y₁Z₂³, S₂ = Y₂Z₁³
H = U₂ - U₁, R = S₂ - S₁

X₃ = R² - H³ - 2U₁H²
Y₃ = R(U₁H² - X₃) - S₁H³
Z₃ = Z₁Z₂H
```

**复杂度分析**:
- 仿射坐标点加法: 1I + 2M (I为模逆，M为模乘)
- 雅可比坐标点加法: 12M
- 性能提升: 当I ≈ 80M时，提升约6.7倍

### 3.2 Montgomery阶梯算法

```
输入: 标量k = (k_{t-1}, ..., k_1, k_0)₂, 点P
输出: [k]P

R₀ ← O, R₁ ← P
for i = t-1 down to 0:
    if k_i = 0:
        R₁ ← R₀ + R₁
        R₀ ← 2R₀
    else:
        R₀ ← R₀ + R₁
        R₁ ← 2R₁
return R₀
```

**安全性**: 每次迭代执行固定数量的运算，防止时间侧信道攻击。

### 3.3 窗口方法优化

对于窗口大小w，预计算：
```
P, 3P, 5P, ..., (2^w - 1)P
```

标量乘法复杂度从1.5t降低到t/(w+1) + tw/2^w。

**最优窗口大小**:
对于256位标量，w = 4时达到最佳性能，预计算15个点。

## 4. 安全性分析

### 4.1 椭圆曲线离散对数问题

**问题定义**: 给定E(Fp)上的点P和Q，求整数k使得Q = [k]P

**最佳攻击**: Pollard's rho算法
- 时间复杂度: O(√n)
- 空间复杂度: O(1)

### 4.2 SM2安全等级

对于256位椭圆曲线：
- 安全等级: 128位
- 等效RSA密钥长度: 3072位
- 破解时间估计: 2^128次运算

### 4.3 侧信道攻击防护

**时间攻击**: Montgomery阶梯确保恒定时间
**功耗攻击**: 随机化投影坐标
**故障攻击**: 运算结果验证

## 5. 性能理论分析

### 5.1 计算复杂度

| 操作 | 复杂度 | 说明 |
|------|--------|------|
| 模乘 | O(n²) | n为位长度 |
| 模逆 | O(n³) | 扩展欧几里得算法 |
| 点加法 | O(n²) | 主要是域运算 |
| 标量乘法 | O(n³) | n次点运算 |

### 5.2 优化效果预期

**雅可比坐标**: 消除模逆运算，理论加速 I/12M ≈ 6.7倍
**预计算表**: 减少50%点运算，理论加速2倍
**窗口方法**: 减少(w-1)/(w+1)点运算，w=4时加速1.5倍

**综合优化**: 理论最大加速 6.7 × 2 × 1.5 ≈ 20倍

### 5.3 实际性能分析

由于实际实现中的开销（内存访问、条件分支等），实际加速比通常为理论值的20-40%，即4-8倍的性能提升是合理的预期。

## 6. 结论

SM2椭圆曲线数字签名算法的数学基础扎实，通过多层次的优化技术可以获得显著的性能提升。本项目的实现验证了理论分析的正确性，在保证安全性的前提下实现了实用化的性能水平。
