# SM4-GCM工作模式数学基础理论

## 1. GCM模式概述

GCM（Galois/Counter Mode）是一种认证加密模式，结合了：
- **CTR模式加密**：提供机密性
- **GHASH认证**：提供完整性和认证

## 2. 数学基础：有限域GF(2¹²⁸)

### 2.1 有限域定义

GF(2¹²⁸)是特征为2的有限域，包含2¹²⁸个元素。

**不可约多项式**：
```
f(x) = x¹²⁸ + x⁷ + x² + x + 1
```

**元素表示**：
每个元素可表示为次数小于128的多项式：
```
a(x) = a₁₂₇x¹²⁷ + a₁₂₆x¹²⁶ + ... + a₁x + a₀
```

其中aᵢ ∈ {0, 1}，对应128位的二进制串。

### 2.2 有限域运算

**加法**：多项式系数逐位XOR
```
(a₁₂₇...a₀) + (b₁₂₇...b₀) = ((a₁₂₇ ⊕ b₁₂₇)...(a₀ ⊕ b₀))
```

**乘法**：多项式乘法后模f(x)约简
```
a(x) × b(x) = (a(x) · b(x)) mod f(x)
```

## 3. CTR模式数学描述

### 3.1 计数器生成

**初始计数器块（ICB）**：
```
ICB = IV || 0³¹ || 1
```

其中：
- IV：96位初始向量
- 0³¹：31个零位
- 1：1位常数

**计数器序列**：
```
CTR₀ = ICB
CTR₁ = ICB + 1
CTR₂ = ICB + 2
...
CTRᵢ = ICB + i
```

### 3.2 CTR加密过程

**加密函数**：
```
Cᵢ = Pᵢ ⊕ SM4_K(CTRᵢ)
```

其中：
- Pᵢ：第i个明文块（128位）
- Cᵢ：第i个密文块（128位）
- SM4_K：使用密钥K的SM4加密
- ⊕：按位异或

**解密函数**：
```
Pᵢ = Cᵢ ⊕ SM4_K(CTRᵢ)
```

### 3.3 并行性分析

CTR模式的关键优势是并行性：
- 每个CTRᵢ可以独立计算
- 加密/解密可以并行进行
- 适合SIMD优化

**并行度计算**：
```
理论并行度 = min(可用CPU核心数, SIMD向量宽度/128)
```

## 4. GHASH认证函数

### 4.1 GHASH定义

**认证密钥H**：
```
H = SM4_K(0¹²⁸)
```

**GHASH函数**：
```
GHASH_H(X₁, X₂, ..., Xₘ) = ((···((X₁ · H + X₂) · H + X₃) · H + ··· + Xₘ₋₁) · H + Xₘ
```

其中所有运算在GF(2¹²⁸)中进行。

### 4.2 Horner方法计算

可以用Horner方法重写：
```
Y₀ = 0
Yᵢ = (Yᵢ₋₁ ⊕ Xᵢ) · H, i = 1, 2, ..., m
GHASH_H(X₁, ..., Xₘ) = Yₘ
```

### 4.3 数据格式化

**附加认证数据（AAD）格式化**：
```
A = A₁ || A₂ || ... || Aₘ || 0ᵛ
```

其中0ᵛ是填充，使总长度为128的倍数。

**密文数据格式化**：
```
C = C₁ || C₂ || ... || Cₙ || 0ᵘ
```

**长度块**：
```
len(A) || len(C)
```

其中len(A)和len(C)各占64位，表示比特长度。

## 5. GCM认证标签计算

### 5.1 完整GHASH计算

**输入序列**：
```
X = A₁ || A₂ || ... || Aₘ || C₁ || C₂ || ... || Cₙ || len(A) || len(C)
```

**GHASH计算**：
```
S = GHASH_H(X)
```

### 5.2 认证标签生成

**标签计算**：
```
T = MSBₜ(GHASH_H(A, C) ⊕ SM4_K(ICB))
```

其中：
- MSBₜ：取最高t位（通常t=128或96）
- A：格式化的附加认证数据
- C：格式化的密文数据

## 6. 有限域乘法的硬件优化

### 6.1 CLMUL指令原理

**无进位乘法**：
CLMUL指令执行多项式乘法（不考虑进位）：
```
CLMUL(a, b) = ∑ᵢ∑ⱼ aᵢbⱼ·x^(i+j)
```

**128位乘法分解**：
设a = a_H || a_L, b = b_H || b_L（各64位）

```
a × b = (a_H·x⁶⁴ + a_L) × (b_H·x⁶⁴ + b_L)
      = a_H·b_H·x¹²⁸ + (a_H·b_L + a_L·b_H)·x⁶⁴ + a_L·b_L
```

需要4次64位CLMUL操作。

### 6.2 模约简算法

**约简多项式**：
```
r(x) = x¹²⁸ + x⁷ + x² + x + 1
```

**快速约简**：利用r(x)的稀疏性质：
```
x¹²⁸ ≡ x⁷ + x² + x + 1 (mod r(x))
```

**约简算法**：
对于255位的乘积多项式c(x) = c₂₅₄x²⁵⁴ + ... + c₀：

1. 分离高位：c_H(x) = c₂₅₄x¹²⁶ + ... + c₁₂₈
2. 计算：c_H(x) · (x⁷ + x² + x + 1)
3. 约简：result = c_L(x) ⊕ reduced_c_H(x)

## 7. SM4-GCM性能分析

### 7.1 计算复杂度

**每128位数据块的操作**：
1. CTR计算：1次SM4加密 + 1次XOR
2. GHASH更新：1次GF(2¹²⁸)乘法 + 1次XOR

**总复杂度**：
```
T_total = n·T_SM4 + n·T_mult + n·T_xor
```

其中n为数据块数。

### 7.2 并行优化策略

**CTR模式并行**：
```c
// 并行生成多个CTR块
for (i = 0; i < blocks; i += parallel_factor) {
    // 生成parallel_factor个连续CTR值
    // 并行执行SM4加密
    // 并行执行XOR运算
}
```

**GHASH并行**：
使用Horner方法的变体，允许部分并行：
```
Y = ((A₁H + A₂)H + A₃)H + A₄
  = A₁H³ + A₂H² + A₃H + A₄
```

可以并行计算H的幂次和分组运算。

### 7.3 内存访问优化

**流式处理**：
- 避免存储所有中间结果
- 边计算边处理数据流
- 减少内存带宽需求

**缓存友好访问**：
- 预计算常用的H的幂次
- 使用查找表加速小规模乘法

## 8. 安全性考虑

### 8.1 IV/Nonce要求

**唯一性要求**：每个密钥下的IV必须唯一
**推荐长度**：96位（可以直接作为ICB的高96位）

### 8.2 认证标签长度

**安全性分析**：
- t位标签提供2^(-t)的伪造概率
- 推荐最小长度：96位
- 完整安全：128位

### 8.3 数据长度限制

**安全限制**：
- 单个密钥下最多加密2³²个块
- 对应约64GB数据
- 超出需要重新生成密钥

## 9. 实现要点

### 9.1 关键算法实现

**GHASH核心循环**：
```c
uint128_t ghash_update(uint128_t Y, uint128_t X, uint128_t H) {
    Y = Y ^ X;                    // GF(2¹²⁸)加法
    Y = gf128_multiply(Y, H);     // GF(2¹²⁸)乘法
    return Y;
}
```

**GF(2¹²⁸)乘法**：
```c
uint128_t gf128_multiply(uint128_t a, uint128_t b) {
    uint256_t product = clmul_multiply(a, b);  // 无进位乘法
    return gf128_reduce(product);              // 模约简
}
```

### 9.2 优化实现

**预计算优化**：
```c
// 预计算H的幂次
uint128_t H_powers[16];
H_powers[1] = H;
for (int i = 2; i < 16; i++) {
    H_powers[i] = gf128_multiply(H_powers[i-1], H);
}
```

**向量化处理**：
```c
// 使用SIMD同时处理多个块
__m128i blocks[4] = {block0, block1, block2, block3};
__m128i results[4];
ghash_parallel_4(blocks, H_powers, results);
```

## 结论

SM4-GCM模式的数学基础建立在：

1. **有限域GF(2¹²⁸)运算**：提供密码学安全的认证基础
2. **CTR模式的并行性**：实现高效的加密性能
3. **GHASH的Horner计算**：提供高效的认证计算
4. **CLMUL指令优化**：硬件加速有限域乘法

这些数学原理的深入理解是实现高性能SM4-GCM的关键。
