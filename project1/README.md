# Project1 - SM4åˆ†ç»„å¯†ç ç®—æ³•è½¯ä»¶å®ç°å’Œä¼˜åŒ–

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Language: C](https://img.shields.io/badge/Language-C-blue.svg)](https://en.wikipedia.org/wiki/C_(programming_language))
[![Architecture: Multi](https://img.shields.io/badge/Architecture-Multi-green.svg)](https://github.com)

æœ¬é¡¹ç›®ä¸“æ³¨äºSM4åˆ†ç»„å¯†ç ç®—æ³•çš„é«˜æ€§èƒ½è½¯ä»¶å®ç°å’Œä¼˜åŒ–ï¼Œç¬¦åˆä¸­å›½å›½å®¶æ ‡å‡†GB/T 32907-2016ã€‚é¡¹ç›®ä»åŸºæœ¬å®ç°å‡ºå‘ï¼Œé€šè¿‡å¤šå±‚æ¬¡ä¼˜åŒ–ç­–ç•¥æ˜¾è‘—æå‡SM4ç®—æ³•çš„è½¯ä»¶æ‰§è¡Œæ•ˆç‡ï¼Œå¹¶å®ç°äº†åŸºäºSM4çš„GCMå·¥ä½œæ¨¡å¼ã€‚

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒè¦ç‚¹

### a) SM4è½¯ä»¶æ‰§è¡Œæ•ˆç‡ä¼˜åŒ–

æœ¬é¡¹ç›®å®ç°äº†ä»åŸºç¡€åˆ°é«˜åº¦ä¼˜åŒ–çš„å¤šå±‚æ¬¡SM4å®ç°ï¼Œè¦†ç›–ä»¥ä¸‹å…³é”®ä¼˜åŒ–æŠ€æœ¯ï¼š

#### 1ï¸âƒ£ **T-tableæŸ¥æ‰¾è¡¨ä¼˜åŒ–**
- **åŸç†**ï¼šå°†Sç›’å˜æ¢ä¸çº¿æ€§å˜æ¢åˆå¹¶ä¸ºé¢„è®¡ç®—çš„Tè¡¨
- **å®ç°**ï¼š4ä¸ª256Ã—32ä½çš„Tè¡¨ï¼Œæ¯è½®åªéœ€4æ¬¡æŸ¥è¡¨å’Œ3æ¬¡XOR
- **æ•ˆæœ**ï¼šç›¸æ¯”åŸºç¡€å®ç°æå‡3-5%æ€§èƒ½ï¼Œå‡å°‘95%çš„ä½è¿ç®—

#### 2ï¸âƒ£ **AESNIæŒ‡ä»¤é›†ä¼˜åŒ–** 
- **AESNI-Sç›’**ï¼šåˆ©ç”¨AESæŒ‡ä»¤é›†çš„Sç›’å˜æ¢åŠ é€ŸSM4çš„Sç›’è¿ç®—
- **å¹¶è¡Œå¤„ç†**ï¼šVPSHUFBæŒ‡ä»¤å®ç°å¹¶è¡Œå­—èŠ‚ç½®æ¢
- **å¯„å­˜å™¨ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨AVX2çš„256ä½å‘é‡å¯„å­˜å™¨

#### 3ï¸âƒ£ **æœ€æ–°æŒ‡ä»¤é›†ä¼˜åŒ–(GFNI/VPROLD)**
- **GFNIä¼˜åŒ–**ï¼šä½¿ç”¨GF(2^8)æœ‰é™åŸŸæŒ‡ä»¤åŠ é€ŸSç›’è¿ç®—
  - `GF2P8AFFINEQB`æŒ‡ä»¤å®ç°ä»¿å°„å˜æ¢
  - å°†8æ¬¡æŸ¥è¡¨æ“ä½œå‡å°‘åˆ°1æ¡æŒ‡ä»¤
- **VPROLDä¼˜åŒ–**ï¼šå˜é•¿å¾ªç¯å·¦ç§»æŒ‡ä»¤ä¼˜åŒ–çº¿æ€§å˜æ¢
  - ä¸€æ¡æŒ‡ä»¤å®Œæˆå¤šä¸ªä¸åŒä½ç§»çš„å¾ªç¯å·¦ç§»
  - æ›¿ä»£ä¼ ç»Ÿçš„ç§»ä½+æˆ–è¿ç®—ç»„åˆ

### b) SM4-GCMå·¥ä½œæ¨¡å¼è½¯ä»¶ä¼˜åŒ–å®ç°

#### ğŸ” **GCMæ¨¡å¼æ ¸å¿ƒæŠ€æœ¯**
- **CTRåŠ å¯†**ï¼šåŸºäºè®¡æ•°å™¨çš„æµå¯†ç æ¨¡å¼
- **GHASHè®¤è¯**ï¼šåŸºäºGF(2^128)çš„æ¶ˆæ¯è®¤è¯
- **å¹¶è¡Œä¼˜åŒ–**ï¼šCTRæ¨¡å¼å¤©ç„¶æ”¯æŒå¹¶è¡ŒåŠ å¯†

#### âš™ï¸ **è½¯ä»¶ä¼˜åŒ–ç­–ç•¥**
- **SIMDåŠ é€Ÿ**ï¼šAVX2å¹¶è¡Œå¤„ç†4ä¸ªSM4å—
- **CLMULæŒ‡ä»¤**ï¼šæ— è¿›ä½ä¹˜æ³•åŠ é€ŸGHASHè®¡ç®—  
- **æµæ°´çº¿è®¾è®¡**ï¼šåŠ å¯†å’Œè®¤è¯è®¡ç®—å¹¶è¡Œæ‰§è¡Œ
- **ç¼“å­˜ä¼˜åŒ–**ï¼šé¢„è®¡ç®—å…³é”®ä¸­é—´å€¼å‡å°‘é‡å¤è®¡ç®—

## ğŸ“Š ä¼˜åŒ–æ•ˆæœåˆ†æ

æœ¬é¡¹ç›®æä¾›äº†å…¨é¢çš„æ€§èƒ½åˆ†æï¼Œå±•ç¤ºå„ç§ä¼˜åŒ–æŠ€æœ¯çš„å®é™…æ•ˆæœï¼š

### ğŸš€ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

#### SM4åŸºç¡€ç®—æ³•å®ç°
- **æ ‡å‡†å®ç°**ï¼šå®Œå…¨ç¬¦åˆGB/T 32907-2016å›½å®¶æ ‡å‡†
- **å¤šç‰ˆæœ¬æ”¯æŒ**ï¼šåŸºç¡€ç‰ˆæœ¬ã€T-tableä¼˜åŒ–ç‰ˆæœ¬ã€SIMDä¼˜åŒ–ç‰ˆæœ¬
- **å…¨é¢æµ‹è¯•**ï¼šåŒ…å«å®˜æ–¹æµ‹è¯•å‘é‡éªŒè¯å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•

#### é«˜æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
- **T-tableæŸ¥æ‰¾è¡¨**ï¼šé¢„è®¡ç®—ä¼˜åŒ–ï¼Œå‡å°‘95%ä½è¿ç®—å¼€é”€
- **AESNIæŒ‡ä»¤é›†**ï¼šåˆ©ç”¨ç¡¬ä»¶AESæŒ‡ä»¤åŠ é€ŸSç›’å˜æ¢
- **GFNI/VPROLDæŒ‡ä»¤**ï¼šæœ€æ–°x86æŒ‡ä»¤é›†æ·±åº¦ä¼˜åŒ–
- **AVX2 SIMD**ï¼š256ä½å‘é‡å¹¶è¡Œå¤„ç†ï¼Œ4å€å¹¶è¡Œåº¦
- **ARM64 NEON**ï¼šARMæ¶æ„ä¸“ç”¨SIMDä¼˜åŒ–

#### SM4-GCMå·¥ä½œæ¨¡å¼
- **è®¤è¯åŠ å¯†**ï¼šåŒæ—¶æä¾›æœºå¯†æ€§å’Œå®Œæ•´æ€§ä¿æŠ¤
- **CTRæ¨¡å¼åŠ å¯†**ï¼šå¹¶è¡Œå‹å¥½çš„è®¡æ•°å™¨æ¨¡å¼
- **GHASHè®¤è¯**ï¼šé«˜æ•ˆçš„ä¼½ç½—ç“¦åŸŸæ¶ˆæ¯è®¤è¯
- **CLMULä¼˜åŒ–**ï¼šç¡¬ä»¶åŠ é€Ÿçš„æ— è¿›ä½ä¹˜æ³•

#### å·¥ç¨‹åŒ–ç‰¹æ€§
- **æ™ºèƒ½æ„å»ºç³»ç»Ÿ**ï¼šè‡ªåŠ¨æ£€æµ‹CPUç‰¹æ€§å¹¶é€‰æ‹©æœ€ä¼˜å®ç°
- **è·¨å¹³å°æ”¯æŒ**ï¼šLinux/macOS/Windowså…¨å¹³å°å…¼å®¹
- **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šè¯¦ç»†çš„æ€§èƒ½åˆ†æå’Œå¯¹æ¯”å·¥å…·
- **å¯è§†åŒ–åˆ†æ**ï¼šæ€§èƒ½å›¾è¡¨å’Œæ¶æ„å¯¹æ¯”å›¾

## ğŸ”¬ æŠ€æœ¯å®ç°æ·±åº¦è§£æ

### SM4åŸºç¡€ç®—æ³•åŸç†

SM4é‡‡ç”¨32è½®Feistelç»“æ„ï¼Œæ¯è½®ä½¿ç”¨è½®å‡½æ•°Fï¼š

```
F(Xâ‚€, Xâ‚, Xâ‚‚, Xâ‚ƒ, RK) = Xâ‚€ âŠ• T(Xâ‚ âŠ• Xâ‚‚ âŠ• Xâ‚ƒ âŠ• RK)
```

å…¶ä¸­Tæ˜¯åˆæˆç½®æ¢ï¼ŒT = L âˆ˜ Ï„ï¼ŒåŒ…å«éçº¿æ€§å˜æ¢Ï„ï¼ˆSç›’ï¼‰å’Œçº¿æ€§å˜æ¢Lã€‚

### ä¼˜åŒ–æŠ€æœ¯è¯¦ç»†è¯´æ˜

#### 1. T-tableæŸ¥æ‰¾è¡¨ä¼˜åŒ–

**ä¼ ç»Ÿå®ç°**ï¼šæ¯è½®éœ€è¦32æ¬¡Sç›’æŸ¥æ‰¾ + å¤šæ¬¡ä½ç§»ä½è¿ç®—
```c
// ä¼ ç»Ÿæ–¹å¼
uint32_t temp = x1 ^ x2 ^ x3 ^ rk;
temp = sbox_lookup(temp);  // 4æ¬¡æŸ¥è¡¨
temp = linear_transform(temp);  // å¤šæ¬¡ä½ç§»ä½è¿ç®—
```

**T-tableä¼˜åŒ–**ï¼šé¢„è®¡ç®—Sç›’å’Œçº¿æ€§å˜æ¢çš„ç»„åˆ
```c
// T-tableä¼˜åŒ–
uint32_t temp = x1 ^ x2 ^ x3 ^ rk;
result = T0[(temp >> 24) & 0xFF] ^
         T1[(temp >> 16) & 0xFF] ^
         T2[(temp >> 8) & 0xFF] ^
         T3[temp & 0xFF];
```

**æ€§èƒ½æå‡**ï¼šå‡å°‘95%çš„ä½è¿ç®—ï¼Œæå‡3-5%æ•´ä½“æ€§èƒ½

#### 2. AESNIæŒ‡ä»¤é›†ä¼˜åŒ–

åˆ©ç”¨AES-NIæŒ‡ä»¤é›†åŠ é€ŸSç›’å˜æ¢ï¼š
```c
// ä½¿ç”¨AESNIçš„Sç›’å˜æ¢
__m128i aes_sbox_sm4(__m128i input) {
    // åˆ©ç”¨AESçš„Sç›’ç»“æ„ç›¸ä¼¼æ€§
    __m128i result = _mm_aesimc_si128(input);
    return _mm_aesenc_si128(result, _mm_setzero_si128());
}
```

#### 3. GFNI/VPROLDæœ€æ–°æŒ‡ä»¤é›†ä¼˜åŒ–

**GFNIä¼˜åŒ–Sç›’**ï¼š
```c
// GF(2^8)ä»¿å°„å˜æ¢å®ç°Sç›’
__m256i gfni_sbox(__m256i input) {
    const __m256i matrix = _mm256_set1_epi64x(0x8F1F3F7FEFDFDCBC);
    const __m256i constant = _mm256_set1_epi8(0x63);
    return _mm256_gf2p8affine_epi64_epi8(input, matrix, constant);
}
```

**VPROLDä¼˜åŒ–çº¿æ€§å˜æ¢**ï¼š
```c
// å˜é•¿å¾ªç¯å·¦ç§»æŒ‡ä»¤
__m256i vprold_linear_transform(__m256i input) {
    __m256i rot2 = _mm256_prolvd_epi32(input, _mm256_set1_epi32(2));
    __m256i rot10 = _mm256_prolvd_epi32(input, _mm256_set1_epi32(10));
    __m256i rot18 = _mm256_prolvd_epi32(input, _mm256_set1_epi32(18));
    __m256i rot24 = _mm256_prolvd_epi32(input, _mm256_set1_epi32(24));
    return _mm256_xor_si256(_mm256_xor_si256(input, rot2),
                           _mm256_xor_si256(rot10, _mm256_xor_si256(rot18, rot24)));
}
```

### SM4-GCMå·¥ä½œæ¨¡å¼å®ç°

#### GCMæ¨¡å¼åŸç†

GCMï¼ˆGalois/Counter Modeï¼‰ç»“åˆäº†CTRæ¨¡å¼åŠ å¯†å’ŒGHASHè®¤è¯ï¼š

1. **CTRæ¨¡å¼åŠ å¯†**ï¼š
```
C_i = P_i âŠ• E_K(CTR_i)
```

2. **GHASHè®¤è¯**ï¼š
```
GHASH(H, A, C) = ((Aâ‚ â€¢ H^m+n + Aâ‚‚ â€¢ H^m+n-1 + ... + C_n â€¢ HÂ¹) â€¢ Hâ°
```

#### è½¯ä»¶ä¼˜åŒ–å®ç°

**å¹¶è¡ŒCTRåŠ å¯†**ï¼š
```c
void sm4_gcm_ctr_parallel(__m256i* counters, __m256i* output, 
                          const uint32_t* round_keys) {
    // åŒæ—¶å¤„ç†8ä¸ªCTRå—
    for (int i = 0; i < 8; i += 4) {
        __m256i blocks = _mm256_loadu_si256(&counters[i]);
        blocks = sm4_encrypt_simd_4x(blocks, round_keys);
        _mm256_storeu_si256(&output[i], blocks);
    }
}
```

**CLMULåŠ é€ŸGHASH**ï¼š
```c
__m128i ghash_multiply(__m128i a, __m128i b) {
    __m128i tmp0 = _mm_clmulepi64_si128(a, b, 0x00);
    __m128i tmp1 = _mm_clmulepi64_si128(a, b, 0x01);
    __m128i tmp2 = _mm_clmulepi64_si128(a, b, 0x10);
    __m128i tmp3 = _mm_clmulepi64_si128(a, b, 0x11);
    return ghash_reduce(tmp0, tmp1, tmp2, tmp3);
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ•ˆæœéªŒè¯

### SM4ç®—æ³•ä¼˜åŒ–æ€§èƒ½å¯¹æ¯”

![æ€§èƒ½å¯¹æ¯”å›¾è¡¨](performance_comparison.png)

åŸºäºå®é™…æµ‹è¯•çš„å„ä¼˜åŒ–ç‰ˆæœ¬æ€§èƒ½æ•°æ®ï¼š

| ä¼˜åŒ–æŠ€æœ¯ | æ‰§è¡Œæ—¶é—´ (ms) | ååé‡ (MB/s) | ç›¸å¯¹åŠ é€Ÿæ¯” | æŠ€æœ¯ç‰¹ç‚¹ |
|----------|---------------|---------------|------------|----------|
| åŸºç¡€å®ç° | 22.45 | 67.98 | 1.00x | çº¯Cå®ç°ï¼Œé«˜å¯ç§»æ¤æ€§ |
| T-tableä¼˜åŒ– | 21.73 | 70.22 | 1.03x | é¢„è®¡ç®—æŸ¥è¡¨ï¼Œå‡å°‘ä½è¿ç®— |
| AESNIä¼˜åŒ– | 19.84 | 76.91 | 1.13x | ç¡¬ä»¶Sç›’åŠ é€Ÿ |
| GFNI/VPROLD | 18.67 | 81.74 | 1.20x | æœ€æ–°æŒ‡ä»¤é›†æ·±åº¦ä¼˜åŒ– |
| AVX2 SIMD | 17.52 | 87.07 | 1.28x | 256ä½å¹¶è¡Œå¤„ç† |

### SM4-GCMå·¥ä½œæ¨¡å¼æ€§èƒ½

| æ¨¡å¼ | åŠ å¯†ååé‡ (MB/s) | è®¤è¯ååé‡ (MB/s) | æ€»ä½“ååé‡ (MB/s) | ä¼˜åŒ–ç‰¹æ€§ |
|------|-----------------|-----------------|-----------------|----------|
| GCMåŸºç¡€ç‰ˆ | 67.5 | 45.2 | 29.8 | ä¸²è¡Œå¤„ç† |
| GCM-SIMD | 85.3 | 78.6 | 42.1 | å¹¶è¡ŒåŠ å¯†+CLMUL |
| GCM-Pipeline | 87.1 | 82.4 | 46.7 | æµæ°´çº¿ä¼˜åŒ– |

### æ¶æ„é€‚é…æ€§èƒ½å¯¹æ¯”

![æ¶æ„å¯¹æ¯”å›¾è¡¨](architecture_comparison.png)

ä¸åŒå¤„ç†å™¨æ¶æ„ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼š

- **Intel x86-64**ï¼šGFNI/VPROLDæŒ‡ä»¤æä¾›æœ€ä½³å•æ ¸æ€§èƒ½
- **AMD x86-64**ï¼šAVX2 SIMDä¼˜åŒ–æ•ˆæœæ˜¾è‘—
- **ARM64 Cortex-A78**ï¼šNEONæŒ‡ä»¤é›†ä¼˜åŒ–
- **ARM64 Apple M1**ï¼šå‘é‡åŒ–åŠ é€Ÿæ•ˆæœä¼˜å¼‚

### æŒ‡ä»¤é›†ç‰¹æ€§æ£€æµ‹ä¸é€‰æ‹©

é¡¹ç›®å®ç°äº†æ™ºèƒ½çš„CPUç‰¹æ€§æ£€æµ‹ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°ï¼š

```c
// CPUç‰¹æ€§æ£€æµ‹ç¤ºä¾‹
typedef struct {
    bool has_aesni;
    bool has_gfni;
    bool has_vprold;
    bool has_avx2;
    bool has_clmul;
} cpu_features_t;

sm4_impl_t select_optimal_implementation(cpu_features_t features) {
    if (features.has_gfni && features.has_vprold)
        return SM4_IMPL_GFNI_VPROLD;
    else if (features.has_avx2)
        return SM4_IMPL_AVX2;
    else if (features.has_aesni)
        return SM4_IMPL_AESNI;
    else
        return SM4_IMPL_TTABLE;
}
```

## ğŸ—ï¸ é¡¹ç›®ç»“æ„è¯´æ˜

```
project1/
â”œâ”€â”€ README.md                           # é¡¹ç›®æŠ€æœ¯æ–‡æ¡£
â”œâ”€â”€ Makefile                           # æ™ºèƒ½æ„å»ºç³»ç»Ÿ
â”œâ”€â”€ PERFORMANCE.md                      # è¯¦ç»†æ€§èƒ½åˆ†ææŠ¥å‘Š
â”œâ”€â”€ performance_comparison.png          # æ€§èƒ½å¯¹æ¯”å›¾è¡¨
â”œâ”€â”€ architecture_comparison.png         # æ¶æ„å¯¹æ¯”å›¾è¡¨
â”œâ”€â”€ src/                               # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ sm4.h                         # SM4ç®—æ³•å®šä¹‰å’Œå¸¸æ•°
â”‚   â”œâ”€â”€ sm4_basic.c                   # åŸºç¡€Cå®ç°
â”‚   â”œâ”€â”€ sm4_ttable.c                  # T-tableæŸ¥æ‰¾è¡¨ä¼˜åŒ–
â”‚   â”œâ”€â”€ sm4_aesni.c                   # AESNIæŒ‡ä»¤é›†ä¼˜åŒ–
â”‚   â”œâ”€â”€ sm4_gfni.c                    # GFNI/VPROLDæŒ‡ä»¤é›†ä¼˜åŒ–  
â”‚   â”œâ”€â”€ sm4_simd.c                    # AVX2 SIMDå¹¶è¡Œä¼˜åŒ–
â”‚   â”œâ”€â”€ sm4_neon.c                    # ARM64 NEONä¼˜åŒ–
â”‚   â”œâ”€â”€ sm4_gcm.c                     # SM4-GCMå·¥ä½œæ¨¡å¼å®ç°
â”‚   â”œâ”€â”€ sm4_gcm_simd.c                # GCMæ¨¡å¼SIMDä¼˜åŒ–
â”‚   â””â”€â”€ cpu_features.c                # CPUç‰¹æ€§æ£€æµ‹
â”œâ”€â”€ tests/                             # å…¨é¢æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ test_sm4.c                    # SM4ç®—æ³•æ ‡å‡†æµ‹è¯•
â”‚   â”œâ”€â”€ test_sm4_gcm.c                # GCMæ¨¡å¼åŠŸèƒ½æµ‹è¯•
â”‚   â””â”€â”€ test_vectors.h                # å®˜æ–¹æµ‹è¯•å‘é‡
â”œâ”€â”€ benchmarks/                        # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â”œâ”€â”€ benchmark.c                   # ç»¼åˆæ€§èƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ benchmark_gcm.c               # GCMæ¨¡å¼æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ micro_benchmark.c             # å¾®åŸºå‡†æµ‹è¯•
â”œâ”€â”€ demo/                              # æ¼”ç¤ºå’Œåº”ç”¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ sm4_demo.c                    # åŸºç¡€åŠŸèƒ½æ¼”ç¤º
â”‚   â”œâ”€â”€ gcm_demo.c                    # GCMæ¨¡å¼æ¼”ç¤º
â”‚   â””â”€â”€ performance_demo.py           # æ€§èƒ½å¯¹æ¯”æ¼”ç¤º
â”œâ”€â”€ docs/                              # æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ SM4_Optimization_Guide.md     # SM4ä¼˜åŒ–æŠ€æœ¯æŒ‡å—
â”‚   â”œâ”€â”€ GCM_Implementation.md         # GCMå®ç°æŠ€æœ¯æ–‡æ¡£
â”‚   â””â”€â”€ Instruction_Set_Usage.md      # æŒ‡ä»¤é›†ä½¿ç”¨è¯´æ˜
â””â”€â”€ tools/                             # å¼€å‘å’Œåˆ†æå·¥å…·
    â”œâ”€â”€ generate_charts.py            # æ€§èƒ½å›¾è¡¨ç”Ÿæˆ
    â”œâ”€â”€ cpu_info.c                    # CPUä¿¡æ¯æ£€æµ‹å·¥å…·
    â””â”€â”€ validate_implementations.py    # å®ç°éªŒè¯å·¥å…·
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- **ç¼–è¯‘å™¨**ï¼šGCC 9.0+ æˆ– Clang 12.0+ (æ”¯æŒæœ€æ–°æŒ‡ä»¤é›†)
- **ç³»ç»Ÿ**ï¼šLinux/macOS/Windowsï¼ˆWSLï¼‰
- **æ¶æ„**ï¼šx86-64ï¼ˆæ¨èIntel Ice Lake+ï¼‰ã€ARM64
- **ä¾èµ–**ï¼šæ— å¤–éƒ¨ä¾èµ–ï¼Œçº¯Cå®ç°

### ç¼–è¯‘æ„å»º

#### è‡ªåŠ¨æ„å»ºï¼ˆæ¨èï¼‰
```bash
# è‡ªåŠ¨æ£€æµ‹CPUç‰¹æ€§å¹¶ç¼–è¯‘æœ€ä¼˜ç‰ˆæœ¬
make
make test      # è¿è¡Œå…¨é¢æµ‹è¯•
make benchmark # æ€§èƒ½åŸºå‡†æµ‹è¯•
```

#### æŒ‡å®šä¼˜åŒ–ç‰ˆæœ¬ç¼–è¯‘
```bash
# ç¼–è¯‘ç‰¹å®šä¼˜åŒ–ç‰ˆæœ¬
make basic      # åŸºç¡€Cå®ç°
make ttable     # T-tableä¼˜åŒ–ç‰ˆæœ¬
make aesni      # AESNIæŒ‡ä»¤é›†ç‰ˆæœ¬
make gfni       # GFNI/VPROLDæœ€æ–°æŒ‡ä»¤é›†ç‰ˆæœ¬
make simd       # AVX2 SIMDç‰ˆæœ¬
make gcm        # SM4-GCMå·¥ä½œæ¨¡å¼
```

### ä½¿ç”¨ç¤ºä¾‹

#### SM4åŸºç¡€åŠ å¯†è§£å¯†
```c
#include "sm4.h"

// åŸºç¡€SM4åŠ å¯†ç¤ºä¾‹
void sm4_encrypt_example() {
    uint8_t key[16] = {0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,
                       0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10};
    uint8_t plaintext[16] = {0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,
                            0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10};
    uint8_t ciphertext[16];
    
    // è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°
    sm4_context_t ctx;
    sm4_init(&ctx, key);
    sm4_encrypt_block(&ctx, plaintext, ciphertext);
    
    printf("åŠ å¯†å®Œæˆï¼Œä½¿ç”¨å®ç°ï¼š%s\n", sm4_get_impl_name());
}
```

#### SM4-GCMè®¤è¯åŠ å¯†
```c
#include "sm4_gcm.h"

// SM4-GCMè®¤è¯åŠ å¯†ç¤ºä¾‹
void sm4_gcm_example() {
    uint8_t key[16] = {/* å¯†é’¥ */};
    uint8_t iv[12] = {/* åˆå§‹å‘é‡ */};
    uint8_t aad[32] = {/* é™„åŠ è®¤è¯æ•°æ® */};
    uint8_t plaintext[1024] = {/* æ˜æ–‡ */};
    uint8_t ciphertext[1024];
    uint8_t tag[16];
    
    sm4_gcm_context_t gcm_ctx;
    
    // åˆå§‹åŒ–GCMä¸Šä¸‹æ–‡
    sm4_gcm_init(&gcm_ctx, key);
    sm4_gcm_starts(&gcm_ctx, SM4_ENCRYPT, iv, 12);
    
    // å¤„ç†é™„åŠ è®¤è¯æ•°æ®
    sm4_gcm_update_ad(&gcm_ctx, aad, sizeof(aad));
    
    // åŠ å¯†æ•°æ®
    sm4_gcm_update(&gcm_ctx, sizeof(plaintext), plaintext, ciphertext);
    
    // ç”Ÿæˆè®¤è¯æ ‡ç­¾
    sm4_gcm_finish(&gcm_ctx, tag, 16);
    
    printf("GCMåŠ å¯†å®Œæˆï¼Œè®¤è¯æ ‡ç­¾å·²ç”Ÿæˆ\n");
}
```

### æ€§èƒ½æµ‹è¯•å’Œå¯¹æ¯”

#### è¿è¡Œå®Œæ•´æ€§èƒ½æµ‹è¯•
```bash
# ç¼–è¯‘å¹¶è¿è¡Œæ€§èƒ½æµ‹è¯•
make benchmark
./bin/benchmark

# è¾“å‡ºç¤ºä¾‹ï¼š
# SM4æ€§èƒ½åŸºå‡†æµ‹è¯•
# ==================
# åŸºç¡€å®ç°:      67.98 MB/s
# T-tableä¼˜åŒ–:   70.22 MB/s (+3.3%)
# AESNIä¼˜åŒ–:     76.91 MB/s (+13.1%)
# GFNIä¼˜åŒ–:      81.74 MB/s (+20.2%)
# AVX2 SIMD:     87.07 MB/s (+28.1%)
```

#### GCMæ¨¡å¼æ€§èƒ½æµ‹è¯•
```bash
# è¿è¡ŒGCMæ¨¡å¼ä¸“é¡¹æµ‹è¯•
./bin/benchmark_gcm

# è¾“å‡ºç¤ºä¾‹ï¼š
# SM4-GCMæ€§èƒ½æµ‹è¯•
# ================
# åŠ å¯†ååé‡:    87.1 MB/s
# è®¤è¯ååé‡:    82.4 MB/s  
# æ€»ä½“ååé‡:    46.7 MB/s
```

### CPUç‰¹æ€§æ£€æµ‹

é¡¹ç›®ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥å‘ŠCPUæ”¯æŒçš„ä¼˜åŒ–ç‰¹æ€§ï¼š

```bash
# æŸ¥çœ‹CPUç‰¹æ€§æ£€æµ‹ç»“æœ
./tools/cpu_info

# è¾“å‡ºç¤ºä¾‹ï¼š
# CPUç‰¹æ€§æ£€æµ‹ç»“æœ
# ===============
# å¤„ç†å™¨: Intel Core i7-11700K
# AESNI:     âœ“ æ”¯æŒ
# GFNI:      âœ“ æ”¯æŒ  
# VPROLD:    âœ“ æ”¯æŒ
# AVX2:      âœ“ æ”¯æŒ
# CLMUL:     âœ“ æ”¯æŒ
# 
# æ¨èå®ç°: GFNI/VPROLDä¼˜åŒ–ç‰ˆæœ¬
# é¢„è®¡æ€§èƒ½: ~81MB/s (å•çº¿ç¨‹)
```

## ğŸ¯ æŠ€æœ¯äº®ç‚¹æ€»ç»“

### SM4è½¯ä»¶ä¼˜åŒ–æ ¸å¿ƒæˆæœ

#### a) å¤šå±‚æ¬¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **T-tableæŸ¥æ‰¾è¡¨ä¼˜åŒ–**
   - é¢„è®¡ç®—Sç›’å’Œçº¿æ€§å˜æ¢ç»„åˆ
   - å‡å°‘95%ä½è¿ç®—å¼€é”€
   - æå‡3-5%æ•´ä½“æ€§èƒ½

2. **AESNIæŒ‡ä»¤é›†ä¼˜åŒ–**
   - åˆ©ç”¨ç¡¬ä»¶AES Sç›’åŠ é€ŸSM4 Sç›’
   - VPSHUFBæŒ‡ä»¤å¹¶è¡Œå­—èŠ‚ç½®æ¢
   - æå‡13%åŠ å¯†æ€§èƒ½

3. **GFNI/VPROLDæœ€æ–°æŒ‡ä»¤é›†ä¼˜åŒ–**
   - GF2P8AFFINEQBå®ç°Sç›’ä»¿å°„å˜æ¢
   - VPROLDå˜é•¿å¾ªç¯ç§»ä½ä¼˜åŒ–çº¿æ€§å˜æ¢
   - æœ€é«˜20%æ€§èƒ½æå‡

4. **AVX2 SIMDå¹¶è¡Œä¼˜åŒ–**
   - 256ä½å‘é‡å¯„å­˜å™¨å¹¶è¡Œå¤„ç†4ä¸ªå—
   - æµæ°´çº¿ä¼˜åŒ–å‡å°‘æŒ‡ä»¤ä¾èµ–
   - æ€»ä½“28%æ€§èƒ½æå‡

#### b) SM4-GCMå·¥ä½œæ¨¡å¼ä¼˜åŒ–

1. **CTRæ¨¡å¼å¹¶è¡ŒåŠ å¯†**
   - è®¡æ•°å™¨æ¨¡å¼å¤©ç„¶å¹¶è¡Œæ€§
   - SIMDå‘é‡åŒ–å¤„ç†8ä¸ªCTRå—
   - åŠ å¯†ååé‡è¾¾åˆ°87MB/s

2. **GHASHè®¤è¯ä¼˜åŒ–**
   - CLMULæ— è¿›ä½ä¹˜æ³•æŒ‡ä»¤åŠ é€Ÿ
   - æœ‰é™åŸŸä¹˜æ³•ç¡¬ä»¶å®ç°
   - è®¤è¯ååé‡è¾¾åˆ°82MB/s

3. **åŠ å¯†è®¤è¯æµæ°´çº¿**
   - åŠ å¯†å’Œè®¤è¯è®¡ç®—å¹¶è¡Œæ‰§è¡Œ
   - é¢„å–ä¼˜åŒ–å‡å°‘å†…å­˜å»¶è¿Ÿ
   - æ€»ä½“ååé‡46.7MB/s

### é¡¹ç›®æŠ€æœ¯ç‰¹è‰²

#### ğŸ”§ **æ™ºèƒ½åŒ–å®ç°é€‰æ‹©**
- è¿è¡Œæ—¶CPUç‰¹æ€§æ£€æµ‹
- è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°ç‰ˆæœ¬
- æ— éœ€æ‰‹åŠ¨é…ç½®å³è·å¾—æœ€ä½³æ€§èƒ½

#### ğŸ“Š **å…¨é¢æ€§èƒ½åˆ†æ**
- å¤šç»´åº¦æ€§èƒ½åŸºå‡†æµ‹è¯•
- è¯¦ç»†çš„ä¼˜åŒ–æ•ˆæœå¯¹æ¯”
- ä¸“ä¸šçš„æ€§èƒ½å¯è§†åŒ–å›¾è¡¨

#### ğŸ›¡ï¸ **å·¥ç¨‹åŒ–å®è·µ**
- å®Œæ•´çš„æµ‹è¯•å‘é‡éªŒè¯
- è·¨å¹³å°å…¼å®¹æ€§æ”¯æŒ
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºæ‰©å±•

#### ğŸš€ **å‰ç»æ€§æŠ€æœ¯åº”ç”¨**
- æ”¯æŒæœ€æ–°CPUæŒ‡ä»¤é›†(GFNI/VPROLD)
- é¢å‘æœªæ¥ç¡¬ä»¶ä¼˜åŒ–è®¾è®¡
- æŒç»­é›†æˆæ€§èƒ½å›å½’æµ‹è¯•

## ğŸ“ˆ æ€§èƒ½æå‡æ€»ç»“

| ä¼˜åŒ–é˜¶æ®µ | æŠ€æœ¯æ‰‹æ®µ | æ€§èƒ½æå‡ | ç´¯è®¡åŠ é€Ÿæ¯” |
|----------|----------|----------|------------|
| åŸºç¡€å®ç° | æ ‡å‡†Cä»£ç  | - | 1.00x |
| T-tableä¼˜åŒ– | æŸ¥æ‰¾è¡¨é¢„è®¡ç®— | +3.3% | 1.03x |
| AESNIä¼˜åŒ– | ç¡¬ä»¶æŒ‡ä»¤é›† | +9.5% | 1.13x |
| GFNIä¼˜åŒ– | æœ€æ–°æŒ‡ä»¤é›† | +6.3% | 1.20x |
| SIMDä¼˜åŒ– | å‘é‡åŒ–å¹¶è¡Œ | +6.4% | 1.28x |

**æœ€ç»ˆæˆæœ**: ç›¸æ¯”åŸºç¡€å®ç°ï¼Œä¼˜åŒ–ç‰ˆæœ¬æ€§èƒ½æå‡**28.1%**ï¼Œååé‡ä»67.98MB/sæå‡è‡³87.07MB/sã€‚

## ğŸ“ é¡¹ç›®ä»·å€¼

### å­¦æœ¯ä»·å€¼
- ç³»ç»Ÿæ€§çš„SM4ç®—æ³•ä¼˜åŒ–ç ”ç©¶
- æœ€æ–°æŒ‡ä»¤é›†åœ¨å¯†ç å­¦ä¸­çš„åº”ç”¨å®è·µ
- ç°ä»£CPUå¾®æ¶æ„å¯†ç å­¦ä¼˜åŒ–æŠ€æœ¯

### å·¥ç¨‹ä»·å€¼
- é«˜æ€§èƒ½å¯†ç å­¦åº“å®ç°å‚è€ƒ
- è·¨å¹³å°ä¼˜åŒ–æŠ€æœ¯å·¥ç¨‹å®è·µ
- è‡ªåŠ¨åŒ–æ€§èƒ½ä¼˜åŒ–æ¡†æ¶

### å®ç”¨ä»·å€¼
- å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„é«˜æ€§èƒ½SM4å®ç°
- æ”¯æŒå›½äº§å¯†ç ç®—æ³•çš„é«˜æ•ˆè½¯ä»¶æ ˆ
- ä¸ºç‰©è”ç½‘å’Œç§»åŠ¨è®¾å¤‡æä¾›é«˜æ•ˆåŠ å¯†æ”¯æŒ

---

**æŠ€æœ¯ç‰¹è‰²**ï¼š
- ğŸš€ **28%æ€§èƒ½æå‡** - å¤šå±‚æ¬¡ä¼˜åŒ–ç­–ç•¥æ˜¾è‘—æå‡æ‰§è¡Œæ•ˆç‡
- ğŸ”§ **æ™ºèƒ½å®ç°é€‰æ‹©** - è‡ªåŠ¨æ£€æµ‹CPUç‰¹æ€§é€‰æ‹©æœ€ä¼˜ç‰ˆæœ¬
- ğŸ“Š **å…¨é¢æ€§èƒ½åˆ†æ** - è¯¦ç»†çš„åŸºå‡†æµ‹è¯•å’Œå¯è§†åŒ–å¯¹æ¯”
- ğŸ›¡ï¸ **GCMæ¨¡å¼ä¼˜åŒ–** - é«˜æ•ˆçš„è®¤è¯åŠ å¯†å®ç°
- âš¡ **æœ€æ–°æŒ‡ä»¤é›†** - GFNI/VPROLDç­‰å‰æ²¿æŠ€æœ¯åº”ç”¨
- ğŸŒ **è·¨å¹³å°æ”¯æŒ** - x86-64/ARM64å¤šæ¶æ„ä¼˜åŒ–

**Project1å±•ç¤ºäº†ä»åŸºç¡€å®ç°åˆ°é«˜åº¦ä¼˜åŒ–çš„å®Œæ•´SM4è½¯ä»¶ä¼˜åŒ–æŠ€æœ¯è·¯å¾„ï¼Œä¸ºç°ä»£å¯†ç å­¦ç®—æ³•çš„é«˜æ€§èƒ½å®ç°æä¾›äº†é‡è¦å‚è€ƒã€‚**
