# 协议规范文档

## DDH-PSI协议详细规范

### 1. 协议目标

DDH-PSI协议旨在解决两方私有集合求交并聚合的问题，在保护双方输入隐私的前提下，安全地计算：
- 交集大小 |V ∩ W|
- 交集中关联值的总和 Σ_{w_j ∈ V} t_j

### 2. 安全模型

**威胁模型**：半诚实敌手模型（Honest-but-Curious）
- 协议参与方严格按照协议执行
- 敌手试图从协议交互中推断额外信息
- 不考虑恶意破坏或偏离协议的行为

**安全目标**：
- **正确性**：诚实执行协议能得到正确结果
- **隐私性**：除了规定的输出外，不泄露其他信息
- **鲁棒性**：协议能够检测和处理异常情况

### 3. 密码学假设

#### 3.1 DDH假设
设G是素数阶q的循环群，g是生成元。DDH假设声明：
对于随机选择的a, b, c ∈ Z_q，以下两个分布计算不可区分：
- D_DDH = {(g, g^a, g^b, g^{ab})}
- D_random = {(g, g^a, g^b, g^c)}

**实例化**：使用NIST椭圆曲线prime256v1（SECP256R1）

#### 3.2 同态加密
使用Paillier加密方案，满足：
- **加法同态性**：E(m1) ⊗ E(m2) = E(m1 + m2)
- **CPA安全性**：密文在选择明文攻击下语义安全
- **重随机化**：能够刷新密文的随机性

### 4. 协议详细流程

#### 4.1 初始化阶段
**输入**：
- Party1: 集合 V = {v_i}_{i=1}^{m1}
- Party2: 集合 W = {(w_j, t_j)}_{j=1}^{m2}

**设置**：
1. 双方约定椭圆曲线群G和哈希函数H: {0,1}* → G
2. Party1选择随机私钥k1 ∈ Z_q
3. Party2选择随机私钥k2 ∈ Z_q
4. Party2生成Paillier密钥对(pk, sk)，发送pk给Party1

#### 4.2 第一轮通信（Party1 → Party2）
Party1计算并发送：
```
X = {H(v_i)^{k1} | v_i ∈ V}
```
发送前随机打乱X的顺序。

**通信量**：m1 × 65字节（椭圆曲线点未压缩格式）

#### 4.3 第二轮通信（Party2 → Party1）
Party2执行两个并行操作：

**操作1**：处理接收到的X，计算
```
Z = {(H(v_i)^{k1})^{k2} | H(v_i)^{k1} ∈ X} = {H(v_i)^{k1k2} | v_i ∈ V}
```

**操作2**：处理自己的数据W，计算
```
Y = {(H(w_j)^{k2}, Enc(t_j)) | (w_j, t_j) ∈ W}
```

发送(Z, Y)给Party1，发送前分别打乱顺序。

**通信量**：m1 × 65 + m2 × (65 + 128)字节

#### 4.4 第三轮通信（Party1 → Party2）
Party1执行：

1. **二次加密**：对Y中的每个椭圆曲线点计算
   ```
   Z' = {(H(w_j)^{k2})^{k1} | (H(w_j)^{k2}, Enc(t_j)) ∈ Y} = {H(w_j)^{k1k2} | (w_j, t_j) ∈ W}
   ```

2. **交集识别**：找到交集索引集合
   ```
   J = {j | H(w_j)^{k1k2} ∈ Z}
   ```

3. **同态聚合**：计算交集中关联值的总和
   ```
   C_sum = ⊕_{j ∈ J} Enc(t_j) = Enc(Σ_{j ∈ J} t_j)
   ```

4. **重随机化**：Refresh(C_sum) 并发送给Party2

**通信量**：128字节（一个Paillier密文）

#### 4.5 输出阶段
- Party2解密C_sum得到交集总和S_J
- 双方都知道交集大小|J|

### 5. 正确性分析

**定理1（协议正确性）**：如果双方诚实执行协议，则输出正确。

**证明要点**：
1. **交集识别正确性**：
   - 由于H是单射（随机预言机），有 w_j = v_i ⇔ H(w_j) = H(v_i)
   - 椭圆曲线群的指数运算保持相等关系：H(w_j)^{k1k2} = H(v_i)^{k1k2} ⇔ H(w_j) = H(v_i)
   - 因此 j ∈ J ⇔ w_j ∈ V

2. **聚合计算正确性**：
   - Paillier加密的加法同态性：⊕_{j ∈ J} Enc(t_j) = Enc(Σ_{j ∈ J} t_j)
   - 解密得到正确的交集总和

### 6. 安全性分析

#### 6.1 Party1的隐私保护

**定理2**：在DDH假设和Paillier加密CPA安全性下，存在多项式时间模拟器S1，使得Party1的视图可被模拟。

**泄露信息**：
- 自身输入V
- Party2输入大小m2
- 交集大小|J|

**模拟策略**：
1. 模拟Party2发送的Z：生成m1个随机椭圆曲线点
2. 模拟Party2发送的Y：生成m2个(随机椭圆曲线点, 随机密文)对
3. 确保恰好|J|个椭圆曲线点在两个集合中重复出现

#### 6.2 Party2的隐私保护

**定理3**：在DDH假设下，存在多项式时间模拟器S2，使得Party2的视图可被模拟。

**泄露信息**：
- 自身输入W
- Party1输入大小m1
- 交集总和S_J

**模拟策略**：
1. 模拟Party1发送的X：生成m1个随机椭圆曲线点
2. 模拟Party1发送的重随机化密文：加密S_J并重随机化

### 7. 复杂度分析

#### 7.1 计算复杂度
- **Party1**：
  - 椭圆曲线标量乘法：O(m1 + m2)次
  - 椭圆曲线点比较：O(m1 × m2)次
  - 同态加法：O(|J|)次

- **Party2**：
  - 椭圆曲线标量乘法：O(m1 + m2)次
  - Paillier加密：O(m2)次
  - Paillier解密：O(1)次

#### 7.2 通信复杂度
总通信量：
```
T_comm = m1 × 65 + m1 × 65 + m2 × (65 + 128) + 128
       = 130 × m1 + 193 × m2 + 128 字节
```

对于m1 = m2 = n的情况：T_comm = O(n)

#### 7.3 存储复杂度
- Party1：O(m1 + m2)存储接收数据
- Party2：O(m1 + m2)存储中间结果

### 8. 优化技术

#### 8.1 椭圆曲线优化
- 使用压缩点表示减少通信量（33字节 vs 65字节）
- 批量椭圆曲线运算优化
- 预计算表加速固定点乘法

#### 8.2 Paillier优化
- 使用Damgård-Jurik变体支持更大明文空间
- 时隙技术打包多个值到单个密文
- 批量模幂运算优化

#### 8.3 网络优化
- 流水线传输重叠计算和通信
- 压缩传输减少带宽需求
- 错误检测和重传机制

### 9. 扩展变体

#### 9.1 阈值变体
如果交集大小小于预设阈值τ，协议中止并返回⊥：
- 增加统计隐私保护
- 防止小交集泄露过多信息

#### 9.2 多值聚合变体
支持计算多种统计量（均值、方差等）：
- 在同态加密中打包多个值
- 并行计算不同聚合函数

#### 9.3 多方扩展
扩展到k方参与的协议：
- 使用多方计算框架
- 星型或环型通信拓扑

### 10. 实现考虑

#### 10.1 参数选择
- **椭圆曲线**：NIST P-256（prime256v1）
- **Paillier模数**：1024位（对应128位安全级别）
- **哈希函数**：SHA-256

#### 10.2 安全实现
- 常时间椭圆曲线运算防止时序攻击
- 安全随机数生成
- 内存安全和密钥清理
- 侧信道攻击防护

#### 10.3 错误处理
- 输入验证和格式检查
- 网络错误和超时处理
- 恶意输入检测和拒绝
- 优雅降级和错误恢复
